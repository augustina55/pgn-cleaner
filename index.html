<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PGN Cleaner + Kids Hint</title>

<style>
body{margin:0;font-family:system-ui;background:#eee}
header{background:#f5f5f5;border-bottom:1px solid #ccc;padding:12px 20px;font-size:18px;font-weight:600}
.toolbar{padding:10px 20px;background:#f0f0f0;border-bottom:1px solid #ccc;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
button,input[type=file],input[type=text]{background:#fff;border:1px solid #bbb;padding:6px 12px;font-size:14px}
button{cursor:pointer}
.container{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:10px;height:calc(100vh - 130px)}
.panel{display:flex;flex-direction:column;background:#fff;border:1px solid #ccc}
.panel h3{margin:0;padding:6px 10px;font-size:13px;background:#f7f7f7;border-bottom:1px solid #ccc}
textarea{flex:1;width:100%;border:none;padding:10px;font-family:Consolas,monospace;font-size:14px;background:#fafafa}
</style>
</head>

<body>

<header>PGN Cleaner + Kids Hint</header>

<div class="toolbar">
<input type="file" id="pgnFile">
<input type="text" id="topicName" placeholder="Enter Topic Name">
<label><input type="checkbox" id="sidePlay"> Add Which Side To Play</label>
<label><input type="checkbox" id="addHint"> Add Hint</label>
<button onclick="cleanPGN()">Clean PGN</button>
<button id="downloadBtn" onclick="downloadPGN()" disabled>Download</button>
</div>

<div class="container">
<div class="panel">
<h3>Input</h3>
<textarea id="input"></textarea>
</div>
<div class="panel">
<h3>Output</h3>
<textarea id="output"></textarea>
</div>
</div>

<script>

// LOAD FILE
pgnFile.onchange=e=>{
let f=e.target.files[0];
if(!f)return;
let r=new FileReader();
r.onload=x=>input.value=x.target.result;
r.readAsText(f);
};


// KIDS HINT
function kidsHint(side){

let questions=[
"Can you find the best move?",
"What is the smartest move here?",
"How can you improve your position?",
"Can you attack something?"
];

let hints=[
"Look for checks first.",
"Try to capture something.",
"See if you can attack the king.",
"Find a safe strong move.",
"Look for a piece in danger."
];

let q=questions[Math.floor(Math.random()*questions.length)];
let h=hints[Math.floor(Math.random()*hints.length)];

return `{${side}}\n{${q}}\n{${h}}`;
}



// CLEANER
function cleanPGN(){

let games=input.value.trim().split(/\n\s*\n(?=\[Event)/);
let out=[];
let topic=topicName.value.trim();
let addSide=sidePlay.checked;
let useHint=addHint.checked;

games.forEach((game,i)=>{

let n=i+1;
let lines=game.split("\n");

let tags={};
let moves=[];

lines.forEach(l=>{

l=l.trim();
if(!l)return;

if(l.startsWith("[")){
let m=l.match(/^\[(\w+)\s+"(.*)"\]/);
if(m) tags[m[1]]=m[2];
}
else moves.push(l);

});


// BUILD REQUIRED TAGS ONLY

let headers=[];

// Event
if(topic) headers.push(`[Event "${topic} : Puzzle ${n}"]`);
else headers.push(`[Event "Puzzle ${n}"]`);

// Force Site empty
headers.push(`[Site ""]`);

if(tags.Date) headers.push(`[Date "${tags.Date}"]`);
if(tags.Round) headers.push(`[Round "${tags.Round}"]`);

headers.push(`[White "Position ${n}"]`);

// ALWAYS EMPTY BLACK
headers.push(`[Black ""]`);

if(tags.Result) headers.push(`[Result "${tags.Result}"]`);

headers.push(`[Annotator "Circlechess"]`);

if(tags.FEN){
headers.push(`[SetUp "1"]`);
headers.push(`[FEN "${tags.FEN}"]`);
}


// CLEAN MOVES
let cleaned=moves.join(" ")
.replace(/\{\[[^\]]*\]\}/g,"")
.replace(/\[%[^\]]*\]/g,"")
.replace(/\{\s*\}/g,"")
.replace(/\s+/g," ")
.trim();


// SIDE TO PLAY
let prefix="";

if(addSide && tags.FEN){

let side="White to play";
if(tags.FEN.includes(" b ")) side="Black to play";

if(useHint) prefix=kidsHint(side)+" ";
else prefix=`{${side}} `;

}

out.push(headers.join("\n")+"\n"+prefix+cleaned);

});

output.value=out.join("\n\n");
downloadBtn.disabled=false;

}


// DOWNLOAD
function downloadPGN(){

let blob=new Blob([output.value],{type:"text/plain"});
let url=URL.createObjectURL(blob);
let a=document.createElement("a");
a.href=url;
a.download="cleaned.pgn";
a.click();
URL.revokeObjectURL(url);

}

</script>

</body>
</html>
